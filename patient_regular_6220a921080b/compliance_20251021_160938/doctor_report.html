<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>åŒ»ç”Ÿç‰ˆæŠ¥å‘Š</title>
<style>

/* ä¼˜åŒ–åï¼šæ·»åŠ æ³¨é‡Šåˆ†ç»„ */
:root {
    /* è‰²å½© - æ–‡æœ¬ä¸èƒŒæ™¯ (Colors - Text & Background) */
    --fg: #222;
    --fg-soft: #444;
    --bg: #fff;
    --muted: #888;
    
    /* è‰²å½© - è¯­ä¹‰ (Colors - Semantic) */
    --pri: #2e7d32;       /* ä¸»è¦é¢œè‰²ï¼Œå¦‚æˆåŠŸ */
    --pri-weak: #e9f5eb;  /* ä¸»è¦é¢œè‰²çš„å¼±åŒ–èƒŒæ™¯ */
    --warn: #c62828;      /* è­¦å‘Š/å±é™©è‰² */
    --bar: #0f766e;       /* ç”¨äºè¾¹æ¡†ã€å¼ºè°ƒæ¡ç­‰ */
    
    /* è‰²å½© - UIç»„ä»¶ (Colors - UI Components) */
    --card: #f6f7f9;      /* å¡ç‰‡èƒŒæ™¯ */
    --border: #ddd;       /* è¾¹æ¡† */
    --btn: #0ea5e9;       /* æŒ‰é’®ä¸»è‰² */
    --btn-hover: #0284c7; /* æŒ‰é’®æ‚¬æµ®è‰² */
}

html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); 
    font-family:"Noto Sans CJK SC","Microsoft YaHei","PingFang SC",Arial; }
body { font-size:14.5px; line-height:1.6; }
.page-container { max-width:1100px; margin:0 auto; padding:16px 20px 80px; }
.meta { color:var(--fg-soft); margin-bottom:12px; }
h1,h2,h3,h4 { color:#111; margin:.7em 0 .45em; position:relative; }
table { border-collapse:collapse; width:100%; margin:.4em 0 .8em; }
th,td { border:1px solid #ccc; padding:6px 8px; vertical-align:top; }
th { background:#f6f7f9; }
blockquote { color:#555; margin:.6em 0; padding-left:.8em; border-left:3px solid #ddd; }
img { max-width:100%; }
hr { border: 0; border-top: 1px solid #eee; margin: 1em 0; }

/* æ‰¹æ³¨å·¥å…·æ¡ï¼ˆé€šç”¨ï¼‰ */
.anno-toolbar {
    position:fixed; left:50%; transform:translateX(-50%);
    bottom:16px; z-index:9999; display:flex; gap:8px; align-items:center;
    background:linear-gradient(90deg,#0ea5e9,#06b6d4); color:#fff;
    padding:10px 12px; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,.15);
}
.anno-toolbar button, .anno-toolbar label.btn {
    appearance:none; border:0; border-radius:10px; padding:8px 10px; cursor:pointer; 
    font-weight:600; background:#ffffff; color:#0b3b48; transition:all .15s ease;
    box-shadow:0 2px 6px rgba(0,0,0,.12);
}
.anno-toolbar button:hover, .anno-toolbar label.btn:hover { transform:translateY(-1px); }
.anno-toolbar .sep { width:1px; height:20px; background:rgba(255,255,255,.6); margin:0 4px; }
.hidden-input { display:none; }

/* æ‰¹æ³¨æŒ‰é’®ï¼ˆé€šç”¨ï¼‰ */
.add-note-btn {
    display:none; position:absolute; right:-4px; top:50%; transform:translate(100%,-50%);
    background:var(--btn); color:#fff; border:0; padding:3px 8px; border-radius:10px; 
    font-size:12px; cursor:pointer;
}
.add-note-btn:hover { background:var(--btn-hover); }

/* ç« èŠ‚äº¤äº’å·¥å…·ï¼ˆé€šç”¨å®¹å™¨ï¼‰ */
.section-tools {
    display:inline-flex; gap:8px; align-items:center; margin-left:8px; 
    transform:translateY(-1px); flex-wrap: wrap;
}
.section-tools select, .section-tools input[type="checkbox"] {
    font-size:12px; padding:2px 6px;
}
.section-tools .chip {
    font-size:12px; padding:2px 8px; border:1px solid var(--border); 
    border-radius:10px; background:#fff;
}
.section-tools .btn-mini {
    font-size:12px; padding:2px 8px; border:1px solid var(--border); 
    border-radius:10px; background:#fff; cursor:pointer;
}
.section-tools .btn-mini:hover { background:#f1f5f9; }

/* æ‰¹æ³¨å¡ç‰‡ï¼ˆé€šç”¨ï¼‰ */
.anno-card {
    background:var(--card); border:1px solid var(--border); 
    border-left:4px solid var(--bar); border-radius:12px; padding:10px; 
    margin:8px 0 12px;
}
.anno-card .anno-head { 
    display:flex; justify-content:space-between; align-items:center; 
    margin-bottom:6px; color:var(--fg-soft); font-size:12px; 
}
.anno-card .anno-body[contenteditable="true"] {
    min-height:48px; padding:6px 8px; border-radius:8px; background:#fff; 
    border:1px dashed #cbd5e1; outline:none;
}
.anno-card .anno-actions { text-align:right; margin-top:6px; }
.anno-card .anno-actions button {
    background:#fff; border:1px solid #cbd5e1; border-radius:8px; 
    padding:4px 8px; cursor:pointer; margin-left:6px;
}
.anno-card .anno-actions button:hover { background:#f1f5f9; }

/* å…¨å±€æ‰¹æ³¨ï¼ˆé€šç”¨ï¼‰ */
.global-anno {
    background:#fff; border:1px solid var(--border); border-radius:14px; 
    padding:12px; margin:10px 0 18px; box-shadow:0 2px 10px rgba(0,0,0,.06);
}
.global-anno h3 { margin-top:0; }
.global-anno .area { 
    width:100%; min-height:68px; resize:vertical; padding:8px; 
    border-radius:10px; border:1px solid #cbd5e1; 
}
.global-anno .actions { text-align:right; margin-top:6px; }
.muted { color:var(--muted); font-size:12px; }

@media print {
    .anno-toolbar { display:none!important; }
    .add-note-btn { display:none!important; }
    .section-tools { display:none!important; }
    .page-container { padding-bottom:0; }
    .global-anno { box-shadow:none; border:1px solid #ccc; }
    .anno-card { page-break-inside: avoid; }
}


/* ä¾ä»æ€§æŠ¥å‘Šä¸“ç”¨æ ·å¼ */
.adherence-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 600;
}
.adherence-good { background: #d1fae5; color: #065f46; }
.adherence-warn { background: #fef3c7; color: #92400e; }
.adherence-poor { background: #fee2e2; color: #991b1b; }

/* ç´§è¿«ç¨‹åº¦çŠ¶æ€å¡ç‰‡æ ·å¼ */
.urgency-banner {
    margin: 20px 0;
    padding: 20px;
    border-radius: 12px;
    border-left: 6px solid;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    page-break-inside: avoid;
}

.urgency-banner.urgency-urgent {
    background: #fef2f2;
    border-left-color: #dc2626;
}

.urgency-banner.urgency-attention {
    background: #fffbeb;
    border-left-color: #f59e0b;
}

.urgency-banner.urgency-stable {
    background: #f0fdf4;
    border-left-color: #10b981;
}

.urgency-banner .urgency-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.urgency-banner .urgency-icon {
    font-size: 32px;
}

.urgency-banner h3 {
    margin: 0;
    font-size: 20px;
    color: #111827;
}

.urgency-banner .risk-score {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    margin-left: 12px;
}

.urgency-urgent .risk-score {
    background: #dc2626;
    color: white;
}

.urgency-attention .risk-score {
    background: #f59e0b;
    color: white;
}

.urgency-stable .risk-score {
    background: #10b981;
    color: white;
}

.urgency-banner .reasoning {
    margin: 12px 0;
    font-size: 15px;
    line-height: 1.6;
    color: #374151;
}

.urgency-banner .key-concerns {
    margin: 12px 0;
}

.urgency-banner .key-concerns strong {
    color: #1f2937;
}

.urgency-banner .key-concerns ul {
    margin: 8px 0;
    padding-left: 20px;
}

.urgency-banner .key-concerns li {
    margin: 4px 0;
    color: #4b5563;
}

.urgency-banner .action-row {
    display: flex;
    gap: 20px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(0,0,0,0.1);
}

.urgency-banner .action-item {
    flex: 1;
}

.urgency-banner .action-item strong {
    display: block;
    color: #1f2937;
    margin-bottom: 4px;
}

.urgency-banner .action-item span {
    color: #4b5563;
}

.urgency-banner .verification-note {
    margin-top: 12px;
    padding: 8px 12px;
    background: rgba(0,0,0,0.05);
    border-radius: 6px;
    font-size: 13px;
    color: #6b7280;
}

.urgency-banner .verification-note.failed {
    background: #fef3c7;
    color: #92400e;
}

/* ç›‘æµ‹æŒ‡æ ‡è¡¨æ ¼æ ·å¼ */
.monitoring-table {
    width: 100%;
    border-collapse: collapse;
    margin: 1em 0;
}

.monitoring-table td.out-of-range {
    background-color: #fee;
    color: #c62828;
    font-weight: 600;
}

.monitoring-table input[type="text"] {
    font-size: 14px;
}

</style>
</head>
<body>
<div class="page-container" data-patient-id="patient_regular_6220a921080b" data-report-type="compliance" data-report-id="20251021_160959">
    <div class="meta">æ‚£è€…ï¼š<span id="patient-name-display">åŠ è½½ä¸­...</span> | ç”Ÿæˆæ—¶é—´ï¼š2025-10-21 16:09:59 | æŠ¥å‘ŠIDï¼š20251021_160959</div>
    
    <section class="global-anno" id="global-anno">
        <h3>ğŸ“ å…¨å±€è¯„ä¼°ï¼ˆåŒ»ç”Ÿï¼‰</h3>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">æŠ¥å‘Šè´¨é‡ï¼š</label>
            <select id="globalQualitySelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                <option value="">è¯·é€‰æ‹©...</option>
                <option value="excellent">ä¼˜ç§€ - å®Œå…¨ç¬¦åˆä¸´åºŠéœ€æ±‚</option>
                <option value="good">è‰¯å¥½ - åŸºæœ¬ç¬¦åˆï¼Œæœ‰å°å¹…æ”¹è¿›ç©ºé—´</option>
                <option value="fair">ä¸€èˆ¬ - éœ€è¦æ˜æ˜¾æ”¹è¿›</option>
                <option value="poor">è¾ƒå·® - å­˜åœ¨é‡å¤§é—®é¢˜</option>
            </select>
        </div>
        <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">å…·ä½“æ„è§ï¼š</label>
            <textarea class="area" id="globalAnnoArea" placeholder="åœ¨æ­¤å¡«å†™å…·ä½“è¯„ä¼°æ„è§å’Œæ”¹è¿›å»ºè®®..."></textarea>
        </div>
        <div class="actions muted">è¯„ä¼°å†…å®¹è‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨ï¼ˆä»…æœ¬æœºï¼‰ã€‚æ¯ä»½æŠ¥å‘Šçš„è¯„ä¼°ç‹¬ç«‹å­˜å‚¨ã€‚</div>
    </section>
    
    <h1>æ…¢ç—…é˜¶æ®µç®¡ç†å‘¨æŠ¥ï¼ˆåŒ»ç”Ÿç‰ˆï¼‰</h1>
<h2>ğŸš¨ ç´§è¿«ç¨‹åº¦è¯„ä¼°</h2>
<div class="urgency-banner urgency-urgent">
    <div class="urgency-header">
        <span class="urgency-icon">
            ğŸ”´

        </span>
        <div>
            <h3>ğŸ”´ ç´§æ€¥çº§</h3>
            <span class="risk-score">
                é£é™©ç­‰çº§ï¼š
                ä¸­é£é™©

            </span>
        </div>
    </div>

    <p class="reasoning"><strong>åˆ¤æ–­ç†ç”±ï¼š</strong>æ‚£è€…å­˜åœ¨å¤šä¸ªç”Ÿç†æŒ‡æ ‡å¼‚å¸¸ï¼ŒåŒ…æ‹¬è¡€å‹ã€è¡€ç³–ã€HbA1cã€LDLå’ŒBMIå‡è¶…å‡ºç›®æ ‡èŒƒå›´ï¼Œä¸”å¿ƒç‡åé«˜ã€‚ä¾ä»æ€§æ–¹é¢ï¼Œæœè¯å’Œç›‘æµ‹ä»»åŠ¡å®Œæˆåº¦ä»…ä¸º40%ï¼Œå­˜åœ¨éƒ¨åˆ†éµä»å’Œæ¼æœæƒ…å†µï¼Œå°¤å…¶æ˜¯å¯¹äºŒç”²åŒèƒçš„å‰¯ä½œç”¨æ‹…å¿§å½±å“äº†æœè¯ä¾ä»æ€§ã€‚æ­¤å¤–ï¼Œæ‚£è€…é¥®é£Ÿæ§åˆ¶ä¸ç†æƒ³ï¼Œå¤œé—´è¡€ç³–ç›‘æµ‹æ‰§è¡Œä¸åŠ›ï¼Œå¯èƒ½å½±å“ç—…æƒ…æ§åˆ¶ã€‚ç»¼åˆæ¥çœ‹ï¼Œè™½ç„¶æœªè¾¾åˆ°ç´§æ€¥æ ‡å‡†ï¼Œä½†å¤šé‡é£é™©å› ç´ å åŠ ï¼Œéœ€åŒ»ç”Ÿå…³æ³¨å¹¶è°ƒæ•´ç®¡ç†æ–¹æ¡ˆã€‚</p>

    <div class="key-concerns">
        <strong>å…³é”®å…³æ³¨ç‚¹ï¼š</strong>
        <ul>

            <li>è¡€å‹ã€è¡€ç³–ã€è¡€è„‚åŠBMIå‡è¶…å‡ºç›®æ ‡èŒƒå›´ï¼Œæç¤ºä»£è°¢ç»¼åˆå¾é£é™©å¢åŠ </li>

            <li>æœè¯å’Œè¡€ç³–ç›‘æµ‹ä¾ä»æ€§å·®ï¼Œå¯èƒ½å½±å“ç–¾ç—…æ§åˆ¶</li>

            <li>æ‚£è€…å¯¹è¯ç‰©å‰¯ä½œç”¨å­˜åœ¨é¡¾è™‘ï¼Œå½±å“æ²»ç–—ä¾ä»æ€§</li>

            <li>é‡ç‚¹ä»»åŠ¡æ‰§è¡Œæ³¢åŠ¨ï¼šæ¯æ—¥è¡€ç³–ç›‘æµ‹ï¼ˆæ‚£è€…æåˆ°â€œæ˜¨å¤©æŒ‰ç…§ä½ çš„å»ºè®®ï¼Œç”¨æ‰‹æœºæ‹äº†å‡ æ¬¡è¡€ç³–è®°å½•ï¼Œè¿˜ç®—å®Œæ•´ï¼Œåªæ˜¯æ™šä¸Šçš„é‚£ä¸ªé‡èµ·æ¥ç¡®å®éº»çƒ¦ï¼Œè¿˜å¾—èµ·åºŠå¼„ï¼Œå°±æƒ³å·æ‡’ã€‚â€è¯´æ˜æœ‰è¿›è¡Œè¡€ç³–ç›‘æµ‹ï¼Œä½†å­˜åœ¨ä¸€å®šå›°éš¾å’Œä¸å®Œå…¨åšæŒã€‚ï¼‰</li>

            <li>é‡ç‚¹ä»»åŠ¡æ‰§è¡Œæ³¢åŠ¨ï¼šæŒ‰æ—¶æœè¯ï¼ˆæ‚£è€…è¡¨ç¤ºâ€œä»Šå¤©æ—©ä¸Šèµ·æ™šäº†ç‚¹ï¼Œæ‰€ä»¥æ²¡èƒ½å‡†æ—¶åƒé˜¿æ‰˜ä¼ä»–æ±€ï¼Œä¸è¿‡äºŒç”²åŒèƒè¿˜æ˜¯å‡†æ—¶åƒäº†â€ï¼Œåæ˜ å­˜åœ¨éƒ¨åˆ†æ¼æœæˆ–æœªå‡†æ—¶æœè¯çš„æƒ…å†µã€‚ï¼‰</li>

            <li>é‡ç‚¹ä»»åŠ¡æ‰§è¡Œæ³¢åŠ¨ï¼šå®šæœŸä½“æ£€ï¼ˆç³»ç»Ÿæè®®â€œæˆ‘ä»¬å¯ä»¥è®¡åˆ’ä¸€ä¸‹è¿‘æœŸä½“æ£€ï¼Œæ¯”å¦‚ä¸‰ä¸ªæœˆåçš„æ£€æŸ¥é‡ç‚¹æ˜¯è‚¾åŠŸèƒ½ã€å¿ƒè„å’Œè¡€è„‚â€ï¼Œæ‚£è€…å›åº”â€œè¿™å›å’±ä»¬å®šä¸ªåæœˆåº•å·¦å³å§â€ï¼ŒåŒæ–¹å·²è¾¾æˆåˆæ­¥ä½“æ£€å®‰æ’ï¼Œä½†å°šæœªå®é™…æ‰§è¡Œã€‚ï¼‰</li>

        </ul>
    </div>

    <div class="action-row">
        <div class="action-item">
            <strong>å»ºè®®è¡ŒåŠ¨ï¼š</strong>
            <span>å»ºè®®3å¤©å†…è”ç³»åŒ»ç”Ÿè¯„ä¼°è°ƒæ•´æ²»ç–—æ–¹æ¡ˆï¼Œå¹¶åŠ å¼ºç”¨è¯æ•™è‚²ä¸è¡€ç³–ç›‘æµ‹æŒ‡å¯¼</span>
        </div>
        <div class="action-item">
            <strong>å»ºè®®åŒ»ç”Ÿå’¨è¯¢é—´éš”ï¼š</strong>
            <span>7 å¤©</span>
        </div>
        <div class="action-item">
            <strong>ç”³è¯·ä»‹å…¥ï¼š</strong>
            <span>
                åŒ»ç”Ÿ

            </span>
        </div>
    </div>


    <div class="verification-note failed">
        âš ï¸ è§„åˆ™æ ¡éªŒè°ƒæ•´ï¼šè§„åˆ™æ ¡éªŒï¼šæ£€æµ‹åˆ°3ä¸ªé«˜å±å› ç´ ï¼Œæå‡è‡³ç´§æ€¥çº§ã€‚
    </div>

</div>

<hr />
<h2>ä¸€ã€åŸºæœ¬ä¿¡æ¯</h2>
<ul>
<li>å§“åï¼šNone</li>
<li>æ€§åˆ«ï¼šç”·</li>
<li>å¹´é¾„ï¼š68</li>
<li>èŒä¸šï¼šé€€ä¼‘èŒå·¥</li>
<li>æ–‡åŒ–ç¨‹åº¦ï¼šåˆä¸­</li>
<li>å®¶åº­æƒ…å†µï¼šä¸å®¶äººåŒä½</li>
<li>è”ç³»æ–¹å¼ï¼š138-1234-5678</li>
<li>è¿‡æ•å²ï¼šé’éœ‰ç´ </li>
<li>æ—¢å¾€å²ï¼šIIå‹ç³–å°¿ç—…ã€é«˜è¡€å‹ã€å† å¿ƒç—…</li>
<li>å®¶åº­æ”¯æŒæƒ…å†µï¼šâ€”</li>
</ul>
<hr />
<h2>äºŒã€ä¸»è¦ç–¾ç—…è¯Šæ–­åŠæ²»ç–—</h2>
<ul>
<li>ç–¾ç—…åç§°ï¼šIIå‹ç³–å°¿ç—… ï¼ˆICD10: E11ï¼‰</li>
<li>å½“å‰ç—…æƒ…ï¼šä¸­åº¦</li>
<li>
<p>å½“å‰ç”¨è¯ï¼šäºŒç”²åŒèƒ 500æ¯«å…‹ æ¯æ—¥ä¸¤æ¬¡ï¼ˆå£æœï¼‰ï¼›é˜¿æ‰˜ä¼ä»–æ±€ 20æ¯«å…‹ æ¯æ—¥ä¸€æ¬¡ï¼ˆå£æœï¼‰ï¼›å¡æ‰˜æ™®åˆ© 25æ¯«å…‹ æ¯æ—¥ä¸€æ¬¡ï¼ˆå£æœï¼‰ï¼›é˜¿å¸åŒ¹æ— 100æ¯«å…‹ æ¯æ—¥ä¸€æ¬¡ï¼ˆå£æœï¼‰</p>
</li>
<li>
<p>ç–¾ç—…åç§°ï¼šé«˜è¡€å‹ ï¼ˆICD10: I10ï¼‰</p>
</li>
<li>å½“å‰ç—…æƒ…ï¼šä¸­åº¦</li>
<li>
<p>å½“å‰ç”¨è¯ï¼šäºŒç”²åŒèƒ 500æ¯«å…‹ æ¯æ—¥ä¸¤æ¬¡ï¼ˆå£æœï¼‰ï¼›é˜¿æ‰˜ä¼ä»–æ±€ 20æ¯«å…‹ æ¯æ—¥ä¸€æ¬¡ï¼ˆå£æœï¼‰ï¼›å¡æ‰˜æ™®åˆ© 25æ¯«å…‹ æ¯æ—¥ä¸€æ¬¡ï¼ˆå£æœï¼‰ï¼›é˜¿å¸åŒ¹æ— 100æ¯«å…‹ æ¯æ—¥ä¸€æ¬¡ï¼ˆå£æœï¼‰</p>
</li>
<li>
<p>ç–¾ç—…åç§°ï¼šå† å¿ƒç—… ï¼ˆICD10: I25.1ï¼‰</p>
</li>
<li>å½“å‰ç—…æƒ…ï¼šè½»åº¦</li>
<li>å½“å‰ç”¨è¯ï¼šäºŒç”²åŒèƒ 500æ¯«å…‹ æ¯æ—¥ä¸¤æ¬¡ï¼ˆå£æœï¼‰ï¼›é˜¿æ‰˜ä¼ä»–æ±€ 20æ¯«å…‹ æ¯æ—¥ä¸€æ¬¡ï¼ˆå£æœï¼‰ï¼›å¡æ‰˜æ™®åˆ© 25æ¯«å…‹ æ¯æ—¥ä¸€æ¬¡ï¼ˆå£æœï¼‰ï¼›é˜¿å¸åŒ¹æ— 100æ¯«å…‹ æ¯æ—¥ä¸€æ¬¡ï¼ˆå£æœï¼‰</li>
</ul>
<hr />
<hr />
<h2>ä¸‰ã€æ ¸å¿ƒç›‘æµ‹æŒ‡æ ‡</h2>
<table class="monitoring-table">
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>å½“å‰å€¼</th>
<th>æµ‹é‡æ—¶é—´</th>
<th>æ¨èç›®æ ‡</th>
<th>æ˜¯å¦è¾¾æ ‡</th>
<th>æ˜¯å¦éœ€è¦å¤æŸ¥</th>
</tr>
</thead>
<tbody>
<tr>
<td>è¡€å‹</td>
<td class="out-of-range">160/98 mmHg</td>
<td>2025-10-20</td>
<td>< 140/90 mmHg</td>
<td>æœªè¾¾æ ‡</td>
<td>
<select data-k="monitor.bp.recheck" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px;">
<option value="">è¯·é€‰æ‹©</option>
<option value="yes">éœ€è¦å¤æŸ¥</option>
<option value="no">ä¸éœ€è¦</option>
</select>
</td>
</tr>
<tr>
<td>ç©ºè…¹è¡€ç³–</td>
<td class="out-of-range">9.5 mmol/L</td>
<td>2025-10-20</td>
<td>< 7.0 mmol/Lï¼ˆç©ºè…¹ï¼‰</td>
<td>æœªè¾¾æ ‡</td>
<td>
<select data-k="monitor.bg.recheck" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px;">
<option value="">è¯·é€‰æ‹©</option>
<option value="yes">éœ€è¦å¤æŸ¥</option>
<option value="no">ä¸éœ€è¦</option>
</select>
</td>
</tr>
<tr>
<td>HbA1c</td>
<td class="out-of-range">7.9%</td>
<td>2025-10-20</td>
<td>< 7.0%</td>
<td>æœªè¾¾æ ‡</td>
<td>
<select data-k="monitor.hba1c.recheck" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px;">
<option value="">è¯·é€‰æ‹©</option>
<option value="yes">éœ€è¦å¤æŸ¥</option>
<option value="no">ä¸éœ€è¦</option>
</select>
</td>
</tr>
<tr>
<td>LDL-C</td>
<td class="out-of-range">4.0 mmol/L</td>
<td>2025-10-20</td>
<td>< 2.6 mmol/L</td>
<td>æœªè¾¾æ ‡</td>
<td>
<select data-k="monitor.ldl.recheck" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px;">
<option value="">è¯·é€‰æ‹©</option>
<option value="yes">éœ€è¦å¤æŸ¥</option>
<option value="no">ä¸éœ€è¦</option>
</select>
</td>
</tr>
<tr>
<td>BMI</td>
<td class="out-of-range">26.0 kg/mÂ²</td>
<td>2025-10-20</td>
<td>18.5â€“24.9 kg/mÂ²</td>
<td>æœªè¾¾æ ‡</td>
<td>
<select data-k="monitor.bmi.recheck" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px;">
<option value="">è¯·é€‰æ‹©</option>
<option value="yes">éœ€è¦å¤æŸ¥</option>
<option value="no">ä¸éœ€è¦</option>
</select>
</td>
</tr>
<tr>
<td>å¿ƒç‡</td>
<td class="out-of-range">106 bpm</td>
<td>2025-10-20</td>
<td>60â€“100 bpm</td>
<td>è¾¾æ ‡</td>
<td>
<select data-k="monitor.hr.recheck" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px;">
<option value="">è¯·é€‰æ‹©</option>
<option value="yes">éœ€è¦å¤æŸ¥</option>
<option value="no">ä¸éœ€è¦</option>
</select>
</td>
</tr>
<tr>
<td>è‚¾åŠŸèƒ½</td>
<td >eGFR 70 ml/min/1.73mÂ²</td>
<td>2025-10-20</td>
<td>eGFR â‰¥ 60 ml/min/1.73mÂ²</td>
<td>è¾¾æ ‡</td>
<td>
<select data-k="monitor.kidney.recheck" style="width:100%; padding:4px; border:1px solid #ddd; border-radius:4px;">
<option value="">è¯·é€‰æ‹©</option>
<option value="yes">éœ€è¦å¤æŸ¥</option>
<option value="no">ä¸éœ€è¦</option>
</select>
</td>
</tr>
</tbody>
</table>

<h3>æŒ‡æ ‡è¶‹åŠ¿å›¾</h3>
<h4>è¡€å‹å˜åŒ–</h4>
<p><img alt="" src="assets/bp_trend.png" /></p>
<h4>è¡€ç³–å˜åŒ–</h4>
<p><img alt="" src="assets/glucose_trend.png" /></p>
<h4>ä½“é‡/BMI/å¿ƒç‡å¯¹æ¯”</h4>
<p><img alt="" src="assets/monthly_comparison.png" /></p>
<hr />
<h2>å››ã€ç”Ÿæ´»æ–¹å¼å¤„æ–¹</h2>
<ul>
<li>é¥®é£Ÿï¼šé™åˆ¶ç³–åˆ†å’Œç›åˆ†æ‘„å…¥ï¼Œå¤šæ‘„å…¥é«˜çº¤ç»´é£Ÿç‰©ï¼Œä¿æŒå‡è¡¡é¥®é£Ÿã€‚</li>
<li>è¿åŠ¨ï¼šæ¯å‘¨è¿›è¡Œä¸­ç­‰å¼ºåº¦æœ‰æ°§è¿åŠ¨3-4æ¬¡ï¼Œæ¯æ¬¡30åˆ†é’Ÿã€‚</li>
<li>ç¡çœ ï¼šä¿è¯æ¯æ™š7-8å°æ—¶é«˜è´¨é‡ç¡çœ ï¼Œè§„å¾‹ä½œæ¯ã€‚</li>
<li>å¿ƒç†ï¼šé€šè¿‡å†¥æƒ³ã€æ·±å‘¼å¸ç­‰æ–¹æ³•ç¼“è§£å‹åŠ›ï¼Œä¿æŒå¿ƒæ€å¹³å’Œã€‚</li>
</ul>
<hr />
<h2>äº”ã€é‡ç‚¹éµä»ä»»åŠ¡æ¸…å•</h2>
<table>
<thead>
<tr>
<th>ä»»åŠ¡</th>
<th>æ‰§è¡Œé¢‘ç‡</th>
<th>æ ¸å¿ƒè¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ¯æ—¥è¡€ç³–ç›‘æµ‹</td>
<td>æ¯æ—¥ä¸‰æ¬¡</td>
<td>é¥­å‰ã€é¥­åå„æµ‹ä¸€æ¬¡è¡€ç³–ä»¥è¯„ä¼°è¡€ç³–æ§åˆ¶æƒ…å†µã€‚</td>
</tr>
<tr>
<td>æŒ‰æ—¶æœè¯</td>
<td>æ¯æ—¥ä¸€æ¬¡è‡³å¤šæ¬¡</td>
<td>ä¸¥æ ¼æŒ‰ç…§å¤„æ–¹æœç”¨è¯ç‰©ï¼Œé¿å…æ¼æœæˆ–éšæ„åœè¯ã€‚</td>
</tr>
<tr>
<td>å®šæœŸä½“æ£€</td>
<td>æ¯å­£åº¦ä¸€æ¬¡</td>
<td>åŠ å¼ºå¿ƒè„ã€è‚¾è„åŠŸèƒ½åŠè¡€è„‚ç›‘æµ‹ï¼Œé¢„é˜²å¹¶å‘ç—‡ã€‚</td>
</tr>
</tbody>
</table>
<hr />
<h2>å…­ã€å¥åº·ç®¡ç†æç¤ºï¼ˆæ¥æºï¼šAIæ™ºèƒ½åˆ†æï¼‰</h2>
<h3>1. ç”¨è¯è¡Œä¸ºç®¡ç†</h3>
<ul>
<li>çŠ¶æ€ï¼šç”¨è¯ä¾ä»æ€§éƒ¨åˆ†éµä»ï¼Œå­˜åœ¨å› å‰¯ä½œç”¨æ‹…å¿§ã€æœè¯æ—¶é—´ä¸è§„å¾‹åŠç»æµé¡¾è™‘å¯¼è‡´çš„æ³¢åŠ¨ã€‚</li>
<li>å»ºè®®ï¼šå»ºè®®ä½¿ç”¨æ‰‹æœºé—¹é’Ÿæé†’æœè¯ï¼Œå»ºç«‹å›ºå®šæœè¯æ—¶é—´ï¼›ä¸åŒ»ç”Ÿæ²Ÿé€šè¯ç‰©å‰¯ä½œç”¨é—®é¢˜ï¼Œå¿…è¦æ—¶è°ƒæ•´å‰‚é‡æˆ–æ›´æ¢è¯ç‰©ï¼›å®šæœŸè¯„ä¼°è¯ç‰©ç»æµè´Ÿæ‹…ã€‚</li>
<li>åŒ»ç”Ÿè¡¥å……ï¼šå…³æ³¨æ‚£è€…å¯¹äºŒç”²åŒèƒçš„å‰¯ä½œç”¨æ‹…å¿§åŠé˜¿æ‰˜ä¼ä»–æ±€æœè¯å»¶è¿Ÿé—®é¢˜ï¼Œéœ€åŠ å¼ºç”¨è¯æ•™è‚²å’Œéšè®¿ã€‚</li>
<li>é£é™©æç¤ºï¼šä¸ä¾ä»å¯èƒ½å¯¼è‡´è¡€ç³–ã€è¡€å‹æ§åˆ¶ä¸ä½³ï¼Œå¢åŠ å¿ƒè¡€ç®¡äº‹ä»¶é£é™©ã€‚</li>
</ul>
<h3>2. æŒ‡æ ‡ç›‘æµ‹</h3>
<ul>
<li>çŠ¶æ€ï¼šè¡€ç³–ã€è¡€å‹ã€è¡€è„‚ã€BMIã€å¿ƒç‡å‡è¶…å‡ºç›®æ ‡èŒƒå›´ï¼Œç›‘æµ‹é¢‘ç‡ä¸è¶³ä¸”è®°å½•ä¸å®Œæ•´ã€‚</li>
<li>å»ºè®®ï¼šæ¯æ—¥è‡³å°‘æµ‹é‡3æ¬¡è¡€ç³–ï¼ˆç©ºè…¹ã€é¤å‰ã€é¤åï¼‰ï¼Œæ¯å‘¨æµ‹é‡è¡€å‹2-3æ¬¡ï¼›ä½¿ç”¨æ‰‹æœºæ‹ç…§ä¿å­˜æ•°æ®å¹¶è®¾ç½®æé†’ï¼›å®šæœŸå¤æŸ¥HbA1cå’Œè¡€è„‚ã€‚</li>
<li>åŒ»ç”Ÿè¡¥å……ï¼šéœ€ç»“åˆè¡€ç³–æ³¢åŠ¨è¶‹åŠ¿åˆ†æç—…æƒ…å˜åŒ–ï¼Œè­¦æƒ•ä½è¡€ç³–åŠæ…¢æ€§å¹¶å‘ç—‡è¿›å±•ã€‚</li>
<li>é£é™©æç¤ºï¼šæŒ‡æ ‡å¼‚å¸¸å¯èƒ½åŠ é€Ÿç³–å°¿ç—…å¹¶å‘ç—‡å‘å±•ï¼Œå¦‚è§†ç½‘è†œç—…å˜ã€è‚¾åŠŸèƒ½æ¶åŒ–ç­‰ã€‚</li>
</ul>
<h3>3. è¿åŠ¨ç®¡ç†</h3>
<ul>
<li>çŠ¶æ€ï¼šè¿åŠ¨ä¹ æƒ¯è‰¯å¥½ï¼ŒåšæŒæ¯æ—¥æ—©æ™¨æ•£æ­¥ï¼Œç¬¦åˆæ¨èçš„ä¸­ç­‰å¼ºåº¦è¿åŠ¨ã€‚</li>
<li>å»ºè®®ï¼šä¿æŒç°æœ‰è¿åŠ¨æ¨¡å¼ï¼Œå¯é€‚å½“å¢åŠ è¿åŠ¨å¼ºåº¦æˆ–å°è¯•å…¶ä»–å½¢å¼å¦‚å¤ªæã€éª‘è½¦ç­‰ä»¥æé«˜è¶£å‘³æ€§ã€‚</li>
<li>åŒ»ç”Ÿè¡¥å……ï¼šè¿åŠ¨æœ‰åŠ©äºæ”¹å–„èƒ°å²›ç´ æ•æ„Ÿæ€§å’Œå¿ƒè¡€ç®¡å¥åº·ï¼Œåº”é¼“åŠ±æŒç»­è¿›è¡Œã€‚</li>
<li>é£é™©æç¤ºï¼šç¼ºä¹è¿åŠ¨å°†åŠ é‡ä»£è°¢ç´Šä¹±ï¼Œå¢åŠ å¿ƒè„‘è¡€ç®¡ç–¾ç—…é£é™©ã€‚</li>
</ul>
<h3>4. é¥®é£Ÿç®¡ç†</h3>
<ul>
<li>çŠ¶æ€ï¼šé¥®é£Ÿæ§åˆ¶åŸºæœ¬è¾¾æ ‡ï¼Œä½†å®¶åº­æ”¯æŒä¸è¶³ï¼Œé¥®é£Ÿåå’¸ï¼Œéš¾ä»¥é•¿æœŸåšæŒæ¸…æ·¡é¥®é£Ÿã€‚</li>
<li>å»ºè®®ï¼šå¯»æ‰¾ç¬¦åˆåœ°æ–¹å£å‘³çš„å¥åº·èœè°±ï¼Œäº‰å–å®¶äººæ”¯æŒï¼›å‡å°‘ç›åˆ†æ‘„å…¥ï¼Œå¢åŠ è”¬èœå’Œä¼˜è´¨è›‹ç™½æ¯”ä¾‹ã€‚</li>
<li>åŒ»ç”Ÿè¡¥å……ï¼šéœ€å¼ºè°ƒä½ç›ã€ä½è„‚é¥®é£Ÿå¯¹é«˜è¡€å‹å’Œç³–å°¿ç—…ç®¡ç†çš„é‡è¦æ€§ï¼Œå®šæœŸè¯„ä¼°è¥å…»çŠ¶å†µã€‚</li>
<li>é£é™©æç¤ºï¼šé«˜ç›é¥®é£Ÿå¯èƒ½åŠ é‡é«˜è¡€å‹ï¼Œå¢åŠ å¿ƒè¡€ç®¡ç–¾ç—…é£é™©ã€‚</li>
</ul>
<h3>5. å¿ƒç†ä¸å®¶åº­æ”¯æŒ</h3>
<ul>
<li>çŠ¶æ€ï¼šå¿ƒç†çŠ¶æ€å°šå¯ï¼Œæœ‰å†¥æƒ³å’Œæ·±å‘¼å¸ç­‰å‡å‹æ–¹å¼ï¼Œä½†å­˜åœ¨ç”Ÿæ´»å‹åŠ›å¤§ã€å¯¹æ²»ç–—æ–¹æ¡ˆæœ‰é¡¾è™‘ã€‚</li>
<li>å»ºè®®ï¼šç»§ç»­é‡‡ç”¨æ”¾æ¾è®­ç»ƒç¼“è§£å‹åŠ›ï¼Œå¿…è¦æ—¶å¯»æ±‚å¿ƒç†å’¨è¯¢ï¼›ä¸å®¶äººæ²Ÿé€šæ²»ç–—æ„Ÿå—ï¼Œå¢å¼ºç¤¾ä¼šæ”¯æŒã€‚</li>
<li>åŒ»ç”Ÿè¡¥å……ï¼šéœ€å…³æ³¨æ‚£è€…å¯¹è¯ç‰©å‰¯ä½œç”¨å’Œç»æµè´Ÿæ‹…çš„ç„¦è™‘ï¼Œæä¾›æƒ…æ„Ÿæ”¯æŒå’Œä¿¡æ¯æ”¯æŒã€‚</li>
<li>é£é™©æç¤ºï¼šå¿ƒç†å‹åŠ›å¯èƒ½å½±å“ä¾ä»æ€§å’Œè¡€ç³–æ§åˆ¶ï¼Œå¢åŠ å¹¶å‘ç—‡é£é™©ã€‚</li>
</ul>
<hr />
<h2>ä¸ƒã€ä¾ä»æ€§ä¸APPä½¿ç”¨æƒ…å†µ</h2>
<ul>
<li>æ‰“å¡æƒ…å†µï¼šè¿‘æœˆæ‰“å¡ 3 å¤©</li>
<li>ç—‡çŠ¶åé¦ˆï¼šç—‡çŠ¶åé¦ˆ 0 æ¬¡</li>
<li>åœ¨çº¿å’¨è¯¢ï¼šçº¿ä¸Šå’¨è¯¢ 0 æ¬¡</li>
<li>é—®å·å®Œæˆæƒ…å†µï¼šé—®å· 0 æ¬¡</li>
<li>ä¾ä»æ€§æ€»ä½“ï¼šè¿‘10æ¡è®°å½•ï¼Œå®Œå…¨éµä» 40.0%</li>
</ul>
<h3>ä¾ä»æ€§è¶‹åŠ¿å›¾</h3>
<p><img alt="" src="assets/adherence_trend.png" /></p>
<hr />
<h2>å…«ã€AI ç»¼åˆåˆ†æ</h2>
<ul>
<li>æ€»ç»“ï¼šæ‚£è€…ä¸º68å²ç”·æ€§ï¼Œæ‚£æœ‰IIå‹ç³–å°¿ç—…ã€é«˜è¡€å‹å’Œå† å¿ƒç—…ï¼Œç›®å‰å„é¡¹ç”Ÿç†æŒ‡æ ‡å‡æœªè¾¾æ ‡ï¼Œå­˜åœ¨æ˜æ˜¾çš„ç”¨è¯ã€ç›‘æµ‹å’Œé¥®é£Ÿä¾ä»æ€§é—®é¢˜ã€‚å°½ç®¡è¿åŠ¨ä¹ æƒ¯è‰¯å¥½ï¼Œä½†æ•´ä½“å¥åº·ç®¡ç†ä»éœ€åŠ å¼ºï¼Œå°¤å…¶éœ€æ”¹å–„ç”Ÿæ´»æ–¹å¼å’Œæå‡ä¾ä»æ€§ã€‚</li>
<li>é£é™©è¯„ä¼°ï¼šä¸»è¦é£é™©å› ç´ åŒ…æ‹¬ï¼šè¡€ç³–å’Œè¡€å‹æ§åˆ¶ä¸ä½³ã€è¯ç‰©ä¾ä»æ€§å·®ã€é¥®é£Ÿåå’¸ã€å¿ƒç†å‹åŠ›è¾ƒå¤§åŠç¼ºä¹å®¶åº­æ”¯æŒã€‚è¿™äº›å› ç´ å¯èƒ½å…±åŒåŠ å‰§æ…¢æ€§ç—…è¿›å±•ï¼Œå¢åŠ å¿ƒè„‘è¡€ç®¡äº‹ä»¶å’Œå¹¶å‘ç—‡é£é™©ã€‚</li>
<li>ä¸ªæ€§åŒ–å»ºè®®ï¼š['åˆ¶å®šä¸ªæ€§åŒ–æœè¯æé†’è®¡åˆ’ï¼Œä½¿ç”¨æ‰‹æœºåº”ç”¨è¾…åŠ©ç®¡ç†è¯ç‰©ã€‚', 'æ¯æ—¥è‡³å°‘æµ‹é‡3æ¬¡è¡€ç³–ï¼Œæ¯å‘¨æµ‹é‡è¡€å‹2-3æ¬¡ï¼Œå¹¶è®°å½•æ•°æ®ã€‚', 'ä¸å®¶å±æ²Ÿé€šé¥®é£Ÿè°ƒæ•´ï¼Œå°è¯•å¥åº·èœè°±ï¼Œå‡å°‘ç›åˆ†æ‘„å…¥ã€‚', 'ç»§ç»­åšæŒæ¯æ—¥æ™¨é—´æ•£æ­¥ï¼Œå¯å¢åŠ è¿åŠ¨å¤šæ ·æ€§ä»¥æé«˜å…´è¶£ã€‚', 'å®šæœŸè¿›è¡Œå¿ƒç†è¯„ä¼°ï¼Œå¿…è¦æ—¶å¼•å…¥å¿ƒç†å’¨è¯¢æˆ–æ”¯æŒå°ç»„ã€‚', 'æ¯3ä¸ªæœˆå¤æŸ¥ä¸€æ¬¡HbA1cã€è¡€è„‚å’Œè‚¾åŠŸèƒ½ï¼ŒåŠæ—¶è°ƒæ•´æ²»ç–—æ–¹æ¡ˆã€‚', 'åŠ å¼ºåŒ»æ‚£æ²Ÿé€šï¼Œæ˜ç¡®æ²»ç–—ç›®æ ‡å’Œé¢„æœŸæ•ˆæœï¼Œå¢å¼ºæ‚£è€…ä¿¡å¿ƒã€‚']</li>
</ul>
<hr />
<blockquote>
<p>æŠ¥å‘Šç”Ÿæˆæ—¥æœŸï¼š2025-10-21
æŠ¥å‘Šå‘¨æœŸï¼š2025-10-14 è‡³ 2025-10-20</p>
</blockquote><hr />
<h2>é™„ï¼šä¾ä»æ€§å¯è§†åŒ–</h2>
<p><img alt="å„ç±»åˆ«ä¾ä»è¶‹åŠ¿" src="assets/adherence_trend.png" /></p>
<p><img alt="ä¸»è¦éä¾ä»åŸå› " src="assets/adherence_causes.png" /></p>
<p><img alt="ç”¨è¯ä¾ä»è¶‹åŠ¿" src="assets/med_adherence_trend.png" /></p>
</div>


<div class="anno-toolbar" id="annoToolbar">
    <button id="toggleAnno">å…³é—­æ‰¹æ³¨æ¨¡å¼</button>
    <div class="sep"></div>
    <button id="exportAnno">å¯¼å‡ºæ‰¹æ³¨ä¸äº¤äº’æ•°æ®</button>
    <label class="btn" for="importAnnoInput">å¯¼å…¥æ•°æ®</label>
    <input id="importAnnoInput" class="hidden-input" type="file" accept="application/json" />
    <button id="clearAnno">æ¸…ç©ºæœ¬åœ°æ•°æ®</button>
    <div class="sep"></div>
    <button id="printView">æ‰“å°å‹å¥½</button>
</div>


<script>

    (() => {
    // ==================== A. é€šç”¨æ ¸å¿ƒå˜é‡ä¸å‡½æ•° ====================
    const patientId = document.querySelector('.page-container')?.dataset?.patientId || 'unknown';
    const reportType = document.querySelector('.page-container')?.dataset?.reportType || 'compliance';
    const reportId = document.querySelector('.page-container')?.dataset?.reportId || '20251021_160959';
    const LS_ANNOTATIONS = `report-annotations::${reportType}::${patientId}::${reportId}`;
    const LS_GLOBAL = `report-annotations-global::${reportType}::${patientId}::${reportId}`;
    const LS_INTERACTIONS = `report-interactions::${reportType}::${patientId}::${reportId}`;
    let annoMode = true;

    function nowStr() {
      const d = new Date();
      const pad = n => (n<10? '0'+n : ''+n);
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }
    function loadJSON(key, def) { try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(def)); } catch { return def; } }
    function saveJSON(key, val) { localStorage.setItem(key, JSON.stringify(val || {})); }
    function loadAnnotations() { return loadJSON(LS_ANNOTATIONS, {}); }
    function saveAnnotations(data) { saveJSON(LS_ANNOTATIONS, data); }
    function loadGlobal() { return localStorage.getItem(LS_GLOBAL) || ''; }
    function saveGlobal(val) { localStorage.setItem(LS_GLOBAL, val || ''); }
    function loadInteracts() { return loadJSON(LS_INTERACTIONS, {}); }
    function saveInteracts(obj) { saveJSON(LS_INTERACTIONS, obj); }

    // ==================== B. èµ„æºç¼–è¾‘å™¨ä¸“å±é€»è¾‘ ====================
    function setupResourceEditor() {
        if (!window.TRIAGE_RESOURCES_DATA) return;
        const { allResources: ALL_RESOURCES, suggestedIds: SYSTEM_SUGGESTED_IDS } = window.TRIAGE_RESOURCES_DATA;
        let currentSelectedResourceIds = new Set();
        const STORAGE_KEY = 'triage_resources_selection';
        const editButton = document.querySelector('[data-act="edit-resources"]');
        if (!editButton) return;
        const modal = document.getElementById('resourceEditorModal');
        const modalBody = document.getElementById('resourceEditorContent');
        const displayAreaList = document.querySelector('#resource-display-area .resource-list');
        const confirmBtn = document.querySelector('.resource-modal-footer button.primary');
        const cancelBtn = document.querySelector('.resource-modal-footer button:not(.primary)');
        const closeIconBtn = document.querySelector('.resource-modal-header button');
        const countDisplay = document.querySelector('#resourceCount strong');

        function initializeState() {
            currentSelectedResourceIds.clear();
            const store = loadInteracts();
            const savedSelection = store[STORAGE_KEY];
            if (savedSelection && Array.isArray(savedSelection)) {
                currentSelectedResourceIds = new Set(savedSelection);
                console.log('âœ… [èµ„æº] åŠ è½½å·²ä¿å­˜çš„é€‰æ‹©:', savedSelection.length, 'é¡¹');
            } else {
                currentSelectedResourceIds = new Set(SYSTEM_SUGGESTED_IDS);
                store[STORAGE_KEY] = Array.from(currentSelectedResourceIds);
                saveInteracts(store);
                console.log('âœ… [èµ„æº] ä½¿ç”¨ç³»ç»Ÿæ¨èå¹¶å·²ä¿å­˜:', SYSTEM_SUGGESTED_IDS.length, 'é¡¹');
            }
        }

        function updateCounter() {
            const count = modalBody.querySelectorAll('input:checked').length;
            if(countDisplay) countDisplay.textContent = count;
        }

        function openResourceEditor() {
            initializeState();
            modalBody.innerHTML = '';
            Object.entries(ALL_RESOURCES).forEach(([category, resources]) => {
                const categoryTitle = document.createElement('h4');
                categoryTitle.textContent = category;
                modalBody.appendChild(categoryTitle);
                resources.forEach(item => {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = item.id;
                    checkbox.checked = currentSelectedResourceIds.has(item.id);
                    checkbox.onchange = updateCounter;
                    label.appendChild(checkbox);
                    label.append(` ${item.name}`);
                    if(SYSTEM_SUGGESTED_IDS.includes(item.id)) {
                        const badge = document.createElement('span');
                        badge.className = 'system-badge';
                        badge.textContent = '[ç³»ç»Ÿæ¨è]';
                        label.appendChild(badge);
                    }
                    modalBody.appendChild(label);
                });
            });
            updateCounter();
            modal.style.display = 'flex';
            document.body.classList.add('modal-open');
        }

        function closeResourceEditor() {
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
        }

        function saveResourceSelection() {
            currentSelectedResourceIds = new Set(Array.from(modalBody.querySelectorAll('input:checked')).map(cb => cb.value));
            const store = loadInteracts();
            store[STORAGE_KEY] = Array.from(currentSelectedResourceIds);
            saveInteracts(store);
            console.log('ğŸ’¾ [èµ„æº] å·²ä¿å­˜é€‰æ‹©:', store[STORAGE_KEY].length, 'é¡¹');
            renderDisplayArea();
            closeResourceEditor();
        }
        
        function renderDisplayArea() {
            if(!displayAreaList) return;
            displayAreaList.innerHTML = '';
            const selectedByCategory = {};
            const allResourcesFlat = Object.values(ALL_RESOURCES).flat();
            currentSelectedResourceIds.forEach(id => {
                const item = allResourcesFlat.find(i => i.id === id);
                if(item) {
                    const category = item.category || 'æœªåˆ†ç±»';
                    if (!selectedByCategory[category]) selectedByCategory[category] = [];
                    selectedByCategory[category].push(item);
                }
            });
            if (Object.keys(selectedByCategory).length === 0) {
                displayAreaList.innerHTML = '<li>åŒ»ç”Ÿæœªé€‰æ‹©ä»»ä½•èµ„æºã€‚</li>';
                return;
            }
            Object.entries(selectedByCategory).forEach(([categoryName, items]) => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${categoryName}:</strong> `;
                items.forEach(item => {
                    const span = document.createElement('span');
                    span.className = 'resource-item';
                    if (!SYSTEM_SUGGESTED_IDS.includes(item.id)) span.classList.add('added-by-user');
                    span.textContent = item.name;
                    li.appendChild(span);
                });
                displayAreaList.appendChild(li);
            });
        }
        
        if (editButton) editButton.addEventListener('click', openResourceEditor);
        if (confirmBtn) confirmBtn.addEventListener('click', saveResourceSelection);
        if (cancelBtn) cancelBtn.addEventListener('click', closeResourceEditor);
        if (closeIconBtn) closeIconBtn.addEventListener('click', closeResourceEditor);
        initializeState();
        renderDisplayArea();
    }

    // ==================== C. é€šç”¨æ‰¹æ³¨ä¸äº¤äº’é€»è¾‘ ====================
    const SectionKindMap = [{"key": "adherence", "includes": ["\u4f9d\u4ece", "\u4f9d\u4ece\u6027", "\u4f9d\u5f9e"], "tools_html": "\n                <label class=\"chip\"><input type=\"checkbox\" data-k=\"adherence.follow\"> \u9700\u968f\u8bbf</label>\n                <span class=\"chip\">\u5468\u671f\uff1a</span>\n                <select data-k=\"adherence.period\">\n                    <option>1\u5468</option>\n                    <option>2\u5468</option>\n                    <option selected>4\u5468</option>\n                </select>\n                <button class=\"btn-mini\" data-act=\"make-follow\" data-done-text=\"\u5df2\u8bb0\u5f55\">\u8bb0\u5f55\u968f\u8bbf\u4efb\u52a1</button>\n            "}, {"key": "lifestyle", "includes": ["\u751f\u6d3b\u65b9\u5f0f", "\u751f\u6d3b", "\u5e72\u9884"], "tools_html": "\n                <span class=\"chip\">\u751f\u6d3b\u65b9\u5f0f\u6307\u5bfc\uff1a</span>\n                <label class=\"chip\"><input type=\"checkbox\" data-k=\"life.diet\"> \u996e\u98df</label>\n                <label class=\"chip\"><input type=\"checkbox\" data-k=\"life.exercise\"> \u8fd0\u52a8</label>\n                <label class=\"chip\"><input type=\"checkbox\" data-k=\"life.sleep\"> \u7761\u7720</label>\n                <label class=\"chip\"><input type=\"checkbox\" data-k=\"life.psy\"> \u5fc3\u7406</label>\n                <button class=\"btn-mini\" data-act=\"lifestyle-complete\" data-done-text=\"\u5df2\u5b8c\u6210\">\u5b8c\u6210\u6559\u80b2</button>\n            "}, {"key": "tips", "includes": ["\u5efa\u8bae", "\u63d0\u793a", "\u968f\u8bbf\u5efa\u8bae", "\u6cbb\u7597\u5efa\u8bae"], "tools_html": "\n                <span class=\"chip\">\u5efa\u8bae\u91c7\u7eb3\u60c5\u51b5\uff1a</span>\n                <select data-k=\"tips.overall\">\n                    <option value=\"\">\u603b\u4f53\u8bc4\u4ef7</option>\n                    <option>\u5b8c\u5168\u91c7\u7eb3</option>\n                    <option>\u90e8\u5206\u91c7\u7eb3</option>\n                    <option>\u9700\u8981\u4fee\u6539</option>\n                    <option>\u91cd\u65b0\u5236\u5b9a</option>\n                </select>\n                <label class=\"chip\">\u91cd\u70b9\u5173\u6ce8\uff1a</label>\n                <select data-k=\"tips.focus\">\n                    <option value=\"\">\u9009\u62e9\u91cd\u70b9</option>\n                    <option>\u7528\u836f\u4f9d\u4ece\u6027</option>\n                    <option>\u8840\u538b\u76d1\u6d4b</option>\n                    <option>\u8840\u7cd6\u63a7\u5236</option>\n                    <option>\u751f\u6d3b\u65b9\u5f0f</option>\n                </select>\n                <button class=\"btn-mini\" data-act=\"create-plan\" data-done-text=\"\u5df2\u5236\u5b9a\">\u5236\u5b9a\u968f\u8bbf\u8ba1\u5212</button>\n            "}, {"key": "ai", "includes": ["AI", "\u4eba\u5de5\u667a\u80fd", "\u7efc\u5408\u5206\u6790", "\u603b\u7ed3", "\u98ce\u9669\u8bc4\u4f30"], "tools_html": "\n                <span class=\"chip\">AI\u5206\u6790\u786e\u8ba4\uff1a</span>\n                <select data-k=\"ai.summary\">\n                    <option value=\"\">\u603b\u7ed3</option>\n                    <option>\u540c\u610f</option>\n                    <option>\u9700\u4fee\u6539</option>\n                </select>\n                <select data-k=\"ai.risk\">\n                    <option value=\"\">\u98ce\u9669\u8bc4\u4f30</option>\n                    <option>\u540c\u610f</option>\n                    <option>\u9700\u4fee\u6539</option>\n                </select>\n                <select data-k=\"ai.recommendations\">\n                    <option value=\"\">\u5efa\u8bae</option>\n                    <option>\u540c\u610f</option>\n                    <option>\u9700\u4fee\u6539</option>\n                </select>\n                <button class=\"btn-mini\" data-act=\"ai-approve\" data-done-text=\"\u5df2\u786e\u8ba4\">\u786e\u8ba4\u5206\u6790</button>\n            "}];

    function setupSectionAnchors() {
      const headers = document.querySelectorAll('h1, h2, h3, h4');
      headers.forEach((h, idx) => {
        if (!h.id) {
            const text = h.textContent.replace(/[^a-zA-Z0-9ä¸€-é¾¥]/g, '').substring(0, 15);
            h.id = text ? `sec-${text}-${idx}` : `sec-${idx}`;
        }
        const btn = document.createElement('button');
        btn.className = 'add-note-btn';
        btn.textContent = 'â• æ‰¹æ³¨';
        btn.addEventListener('click', () => createNoteCard(h.id));
        h.appendChild(btn);
      });
    }

    function refreshAnnoButtons() {
      document.querySelectorAll('.add-note-btn').forEach(b => b.style.display = annoMode ? 'inline-block' : 'none');
    }

    function renderNotes() {
      const store = loadAnnotations();
      Object.entries(store).forEach(([secId, arr]) => {
        const anchor = document.getElementById(secId);
        if (anchor) arr.forEach(n => insertNoteCardAfter(anchor, n));
      });
    }

    function createNoteCard(secId) {
      const payload = { id: `n-${Date.now()}`, ts: nowStr(), html: '' };
      const store = loadAnnotations();
      (store[secId] = store[secId] || []).push(payload);
      saveAnnotations(store);
      const anchor = document.getElementById(secId);
      if (anchor) insertNoteCardAfter(anchor, payload, true);
    }

    function insertNoteCardAfter(anchorEl, note, focus=false) {
      const card = document.createElement('div');
      card.className = 'anno-card';
      card.dataset.noteId = note.id;
      card.dataset.secId = anchorEl.id;
      card.innerHTML = `<div class="anno-head"><div>ç« èŠ‚ï¼š<code>${anchorEl.textContent.replace('â• æ‰¹æ³¨','').trim()}</code></div><div>æ—¶é—´ï¼š${note.ts}</div></div><div class="anno-body" contenteditable="true" spellcheck="false">${note.html || ''}</div><div class="anno-actions"><button data-act="del">åˆ é™¤</button></div>`;
      const body = card.querySelector('.anno-body');
      body.addEventListener('input', () => {
        const store = loadAnnotations();
        const item = (store[card.dataset.secId] || []).find(x => x.id === card.dataset.noteId);
        if (item) { item.html = body.innerHTML; saveAnnotations(store); }
      });
      card.querySelector('[data-act="del"]').addEventListener('click', () => {
        const store = loadAnnotations();
        let list = store[card.dataset.secId] || [];
        store[card.dataset.secId] = list.filter(x => x.id !== card.dataset.noteId);
        saveAnnotations(store);
        card.remove();
      });
      anchorEl.parentNode.insertBefore(card, anchorEl.nextSibling);
      if (focus) body.focus();
    }

    function injectToolsHTML() {
      if (!SectionKindMap || SectionKindMap.length === 0) return;
      const headers = document.querySelectorAll('h1, h2, h3, h4');
      headers.forEach(h => {
          const titleText = (h.textContent || '').replace(/[\sâ•æ‰¹æ³¨]/g, '');
          const config = SectionKindMap.find(m => m.includes && m.includes.some(k => titleText.includes(k)));
          if (config && config.tools_html) {
              const wrap = document.createElement('span');
              wrap.className = 'section-tools';
              wrap.innerHTML = config.tools_html;
              h.appendChild(wrap);
          }
      });
    }

    function activateInteractiveElements() {
        const store = loadInteracts();
        let hasNewValues = false;
        
        document.querySelectorAll('[data-k]').forEach(el => {
            let header = el.closest('h1, h2, h3, h4');
            if (!header) {
                const wrapper = el.closest('.decision-interactive, .physician-approval-form');
                if (wrapper && wrapper.previousElementSibling?.matches('h1, h2, h3, h4')) {
                    header = wrapper.previousElementSibling;
                }
            }
            
            if (!header) {
                console.warn('âš ï¸ [äº¤äº’] æ— æ³•æ‰¾åˆ°æ ‡é¢˜ï¼Œè·³è¿‡å…ƒç´ :', el.dataset.k);
                return;
            }
            
            const k = `${header.id}::${el.dataset.k}`;
            const savedValue = store[k];
            
            let currentValue;
            if (el.tagName === 'SELECT') {
                currentValue = el.value;
            } else if (el.type === 'checkbox') {
                currentValue = el.checked;
            } else if (el.type === 'radio') {
                if (el.checked) {
                    currentValue = el.value;
                }
            } else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                currentValue = el.value;
            }
            
            if (savedValue !== undefined) {
                if (el.tagName === 'SELECT') {
                    el.value = savedValue;
                    console.log('ğŸ”„ [äº¤äº’] æ¢å¤ä¸‹æ‹‰æ¡†:', k, '=', savedValue);
                } else if (el.type === 'checkbox') {
                    el.checked = !!savedValue;
                    console.log('ğŸ”„ [äº¤äº’] æ¢å¤å¤é€‰æ¡†:', k, '=', savedValue);
                } else if (el.type === 'radio') {
                    if (el.value === savedValue) {
                        el.checked = true;
                        console.log('ğŸ”„ [äº¤äº’] æ¢å¤å•é€‰æ¡†:', k, '=', savedValue);
                    }
                } else if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.value = savedValue;
                    console.log('ğŸ”„ [äº¤äº’] æ¢å¤è¾“å…¥æ¡†:', k, '=', savedValue);
                }
            } else if (currentValue !== '' && currentValue !== undefined) {
                store[k] = currentValue;
                hasNewValues = true;
                console.log('ğŸ’¾ [äº¤äº’] ä¿å­˜é¢„è®¾å€¼:', k, '=', currentValue);
            }
            
            el.addEventListener('change', () => {
                const cur = loadInteracts();
                if (el.type === 'checkbox') {
                    cur[k] = el.checked;
                } else if (el.type === 'radio') {
                    cur[k] = el.value;
                } else {
                    cur[k] = el.value;
                }
                saveInteracts(cur);
                console.log('ğŸ’¾ [äº¤äº’] ä¿å­˜:', k, '=', cur[k]);
            });
        });
        
        if (hasNewValues) {
            saveInteracts(store);
            console.log('âœ… [äº¤äº’] å·²ä¿å­˜æ‰€æœ‰é¢„è®¾å€¼åˆ°localStorage');
        }
    }

    function setupPathSwitching() {
        const switcher = document.querySelector('.path-switcher-select');
        const pathYes = document.getElementById('path-immediate-care');
        const pathNo = document.getElementById('path-home-observation');
        if (!switcher || !pathYes || !pathNo) return; 
        const handleSwitch = () => {
            pathYes.style.display = (switcher.value === 'yes') ? 'block' : 'none';
            pathNo.style.display = (switcher.value === 'no') ? 'block' : 'none';
        };
        switcher.addEventListener('change', handleSwitch);
        handleSwitch();
    }

    function extractPatientName() {
      // å°è¯•ä»å¤šä¸ªä½ç½®æå–æ‚£è€…å§“å
      const basicInfoSection = Array.from(document.querySelectorAll('h2')).find(h => h.textContent.includes('åŸºæœ¬ä¿¡æ¯'));
      if (basicInfoSection) {
        const nextElement = basicInfoSection.nextElementSibling;
        if (nextElement && nextElement.tagName === 'UL') {
          const nameItem = Array.from(nextElement.querySelectorAll('li')).find(li => li.textContent.includes('å§“å'));
          if (nameItem) {
            const match = nameItem.textContent.match(/å§“å[ï¼š:](.*?)(?:$|\n)/);
            if (match) return match[1].trim();
          }
        }
      }
      return 'æ‚£è€…';
    }

    function setupToolbar() {
      const $toggle = document.getElementById('toggleAnno'), $export = document.getElementById('exportAnno'), $import = document.getElementById('importAnnoInput'), $clear = document.getElementById('clearAnno'), $print = document.getElementById('printView'), $global = document.getElementById('globalAnnoArea'), $quality = document.getElementById('globalQualitySelect');
      
      // åŠ è½½å…¨å±€è¯„ä¼°
      const globalData = loadJSON(LS_GLOBAL, { quality: '', comment: '' });
      if (typeof globalData === 'string') {
        // å…¼å®¹æ—§ç‰ˆæœ¬çº¯æ–‡æœ¬
        $global.value = globalData;
      } else {
        $quality.value = globalData.quality || '';
        $global.value = globalData.comment || '';
      }
      
      // ä¿å­˜å…¨å±€è¯„ä¼°
      const saveGlobalData = () => {
        const data = { quality: $quality.value, comment: $global.value };
        saveJSON(LS_GLOBAL, data);
      };
      $quality.addEventListener('change', saveGlobalData);
      $global.addEventListener('input', saveGlobalData);
      
      $toggle.addEventListener('click', () => {
        annoMode = !annoMode;
        $toggle.textContent = annoMode ? 'å…³é—­æ‰¹æ³¨æ¨¡å¼' : 'å¼€å¯æ‰¹æ³¨æ¨¡å¼';
        refreshAnnoButtons();
      });
      $export.addEventListener('click', () => {
        const data = { patient_id: patientId, report_type: reportType, report_id: reportId, exported_at: nowStr(), global: { quality: $quality.value, comment: $global.value }, sections: loadAnnotations(), interactions: loadInteracts() };
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }));
        a.download = `annotations_${reportType}_${patientId}_${reportId}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      });
      $import.addEventListener('change', (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(reader.result);
            if (data?.global !== undefined) saveJSON(LS_GLOBAL, data.global);
            if (data?.sections) saveAnnotations(data.sections);
            if (data?.interactions) saveInteracts(data.interactions);
            location.reload();
          } catch (err) { alert('å¯¼å…¥å¤±è´¥ï¼šJSONæ ¼å¼ä¸æ­£ç¡®'); }
        };
        reader.readAsText(f, 'utf-8');
        e.target.value = '';
      });
      $clear.addEventListener('click', () => {
        if (confirm('ç¡®å®šæ¸…ç©ºæœ¬æŠ¥å‘Šçš„æ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿ')) {
            localStorage.removeItem(LS_ANNOTATIONS);
            localStorage.removeItem(LS_GLOBAL);
            localStorage.removeItem(LS_INTERACTIONS);
            location.reload();
        }
      });
      $print.addEventListener('click', () => window.print());
    }

    document.addEventListener('DOMContentLoaded', () => {
        // æå–å¹¶æ˜¾ç¤ºæ‚£è€…å§“å
        const patientName = extractPatientName();
        const nameDisplay = document.getElementById('patient-name-display');
        if (nameDisplay) {
          nameDisplay.textContent = patientName;
        }
        
        setupSectionAnchors();
        injectToolsHTML();
        activateInteractiveElements();
        setupPathSwitching();
        setupResourceEditor();
        renderNotes();
        setupToolbar();
        refreshAnnoButtons();
    });

    })();
</script>
</body>
</html>